---
sidebar_label: MQTT
title: “MQTT”数据源
description: 使用“MQTT”数据源导入数据到 TDengine Cloud 的实例
---

MQTT 数据写入，是通过连接代理把数据从 MQTT 服务器写入到当前选择的 TDengine Cloud 实例。

## 先决条件

- 创建一个空数据库来存储 MQTT 数据。更多信息，请参阅 [数据库](../../../programming/model/#create-database)。
- 确保连接代理运行在与 MQTT 服务器位于同一网络的机器上。更多信息，请参阅 [安装连接代理](../install-agent/)。

## 具体步骤

1. 在 TDengine Cloud 中，在左边菜单中打开 **数据写入** 页面，在 **数据源** 选项卡上，单击 **添加数据源**打开新增页面。在**名称**输入框里面填写这个数据源的名称，并选择 **MQTT** 类型，在**代理**选择框里面选择已经创建的代理，如果没有创建代理，请点击旁边的**创建新的代理**按钮去创建新代理。
2. 在**目标数据库**里面选择一个当前所在的 TDengine Cloud 实例里面的数据库作为目标数据库。
3. 在 **MQTT 地址**卡片，输入 MQTT 地址，必填字段，包括 IP 和 端口号，例如：192.168.1.10:1883;
4. 在**认证**卡片，输入 MQTT 连接器访问 MQTT 服务器时的用户名和密码，这两个字段为选填字段，如果未输入，即采用匿名认证的方式；
5. 在 **SSL 证书**卡片，可以选择是否打开 SSL/TLS 开关，如果打开此开关，MQTT 连接器和 MQTT 服务器之间的通信将采用 SSL/TLS 的方式进行加密；打开这个开关后，会出现 CA, 客户端证书和客户端私钥三个必填配置项，可以在这里输入证书和私钥文件的内容；
6. 在**采集配置**卡片，可以配置以下信息：
   - MQTT 协议：支持 3.1/3.1.1/5.0 三个版本；
   - Client ID: MQTT 连接器连接 MQTT 服务器时所使用的客户端 ID, 用于标识客户端的身份；
   - Keep Alive: 用于配置 MQTT 连接器与 MQTT 服务器之间的 Keep Alive 时间，默认值为 60 秒；
   - Clean Session: 用于配置 MQTT 连接器是否以 Clean Session 的方式连接至 MQTT 服务器，默认值为 True;
   - 订阅主题及 QoS 配置：这里用来配置监听的 MQTT 主题，以及该主题支持的最大 QoS, 主题和 QoS 的配置之间用::分隔，多个主题之间用,分隔，主题的配置可以支持 MQTT 协议的通配符#和+;
7. 可以点击**连通性检查**, 检查 Cloud 实例 与 MQTT 服务之间是否可以连通。
8. 在**MQTT Payload 解析**卡片，用于配置如何解析 MQTT 消息：
   - 在 **消息体** 中填写 MQTT 消息体中的示例数据，例如：`{"id": 1, "message": "hello-word"}{"id": 2, "message": "hello-word"}`。之后会使用这条示例数据来配置提取和过滤条件。点击 **放大镜图标** 可查看预览解析结果。
   - 在 **从列中提取或拆分** 中填写从消息体中提取或拆分的字段，例如：将 message 字段拆分成 `message_0` 和 `message_1` 这 2 个字段，选择 split 提取器，seperator 填写 -, number 填写 2。点击 **删除**，可以删除当前提取规则。点击 **新增**，可以添加更多提取规则。点击 **放大镜图标** 可查看预览提取/拆分结果。
   - 在 **过滤** 中，填写过滤条件，例如：填写`id != 1`，则只有 id 不为 1 的数据才会被写入 TDengine。点击 **删除**，可以删除当前过滤规则。点击 **放大镜图标** 可查看预览过滤结果。
   - 在 **目标超级表** 的下拉列表中选择一个目标超级表，也可以先点击右侧的 **创建超级表** 按钮，创建一个新的超级表。- 在 **映射** 中，填写目标超级表中的子表名称。点击 **预览**，可以查看映射的结果。
9. 在**高级选项**卡片，可以配置以下信息：
   - **日志级别** 配置连接器的日志级别，支持 error, warn, info, debug, trace 5 个级别，默认值为 info。
   - **保存原始数据时**，以下 2 个参数配置生效。
   - **最大保留天数** 中设置原始数据的最大保留天数。
   - **原始数据存储目录** 中设置原始数据保存路径。
10. 填写完成以上信息后，点击**新增**按钮，即可直接启动从 MQTT 到 TDengine 的数据同步。
